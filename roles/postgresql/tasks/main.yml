---
- hosts: all
  become: yes
  tasks:
    - name: Add PostgreSQL apt repository signing key
      apt_key: url=https://www.postgresql.org/media/keys/ACCC4CF8.asc

    - name: Add PostgreSQL apt repository
      apt_repository:
        repo: deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main
        update_cache: yes

    - name: Install PostgreSQL packages
      apt: "name={{ item }}"
      with_items:
        - libpq-dev
        - postgresql

    - name: Install Ansible PostgreSQL dependencies
      pip:
        name: psycopg2

    - name: Start PostgreSQL service
      service:
        name: postgresql
        state: started

    - name: Get local username
      become: no
      command: whoami
      register: local_username

    - name: Set up default PostgreSQL user
      become_user: postgres
      postgresql_user:
        name: "{{ local_username.stdout }}"
        role_attr_flags: SUPERUSER

    - name: Set up default PostgreSQL database
      become_user: postgres
      postgresql_db:
        name: "{{ local_username.stdout }}"

    - name: Stop PostgreSQL service
      service:
        name: postgresql
        state: stopped
